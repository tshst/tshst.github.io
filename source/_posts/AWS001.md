---
title: AWSのVPNでBGPがうまく動いていない気がする
date: 2019-03-24 10:50:50
tags: AWS, VPN
---

## ネットワークの構成(簡略)
- 拠点が2箇所あり、拠点にはルーターとして、RTX1210がある
- AWSは東京リージョンとバージニアリージョンの2箇所を使用している
- 各拠点からsite-to-siteのVPNで各リージョンに接続している
- Yamaha - VGW(virtual gate way)のネットワークのルーティングは、BGPを使用している

{% asset_img aws-vpn-network-diagram.png  構成図 %}

## 問題
- 各拠点からVPNで各リージョンに接続したいと考えているが問題が発生している
- 東京リージョンのインスタンスからa.a.a.a/24に対して疎通できない

## 切り分け
- バージニアリージョンのインスタンスからa.a.a.a/24に対してtraceすると、1個目のIPはA.A.A.Aとなり、問題なく到達する
- バージニアリージョンのインスタンスからc.c.c.c/24に対してtraceすると、1個目のIPはC.C.C.Cとなり、問題なく到達する
- 東京リージョンのインスタンスからa.a.a.a/24に対してtraceすると、1個目のIPはC.C.C.Cとなる
- 東京リージョンのインスタンスからc.c.c.c/24に対してtraceすると、1個目のIPはC.C.C.Cとなり、問題なく到達する
- YAMAHA側でBGPのステータスを確認したところ、正常

### BGPのルーティングに絞ってリサーチ
- 上記からおそらくVGWのルーティングに問題がある
- しかし、VGWのルーティング情報は参照できない。。。

## BGP周りの情報
- [同じネットワークの場合、マスクの大きさによってルーティングに影響がでる](https://dev.classmethod.jp/cloud/aws/add-vpc-cidr-with-vpn/)
- [AWSでVPNを構築する際の考え方等](https://www.slideshare.net/skikuchi/akibaaws-vpn)
- [VGWのルーティング情報に関する話](https://www.slideshare.net/skikuchi/akibaaws-vgw)

## 対応
- とりあえず、切り分けとして、VGWを作り直して見た
- 作り直したところ、問題なく繋がるようになった
- こうなると再現性がないので、原因特定が難しい
- 再発したら、AWSに問い合わせて調査してもらうようにしよう
